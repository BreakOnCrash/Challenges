# HZRat
## Summary
- **zznQ**: 2024.12.05
- **Malware Sample**: [HZ_RAT.zip](https://github.com/objective-see/Malware/blob/main/HZ_RAT.zip)
- **Tag**: `backdoor`,`DingTalk`,`WeChat`
- **Writup(s)**: 
  - [HZ Rat backdoor for macOS attacks users of Chinaâ€™s DingTalk and WeChat](https://securelist.com/hz-rat-attacks-wechat-and-dingtalk/113513/)

## Analysis
### Extract the pkg file

- `% pkgutil --expand OpenVPNConnect.pkg out`

![](./extract-pkg2.png)

- List `OpenVPN_Connect.pkg/`

![](./extract-pkg3.png)

- Check Scripts
    - `pretinstall`: a macho file
    - `postinstall`: set permissions for OpenVPN Connect.app
    ![](./extract-postinstall.png)
  
  
- Extract payload -> `/Applications/OpenVPN Connect.app`:
  ![](./extract-pyload.png)

  - `OpenVPN Connect.app`: It's a legal App.
  - `exe`: Execute the `init` malicious file in the background and open "OpenVPN Connect.app"
    ![](./extract-exe.png)
  - `init`: a macho file

### Reversing `pretinstall`

- `execvp` is executed at startup
![](./re-pretinstall-execvp.png)

- Dynamic analysis to obtain `execvp` parameters:
  ![](./re-preinstall-lldb.png)

Looks like it did nothing.


### Reversing `init`


- It will connect to the C&C server ip at startup
![](./re-init-c2.png)

- C&C Server IP
![](./re-init-c2-ip.png)

    Here, the port: 0x1f91 => 8081
    - 47.100.65.182:8081
    - 10.9.241.235:8081

- Send Cookie
![](./re-init-cookie.png)
    - Generate a random number as a cookie.
  - Command data is encrypted using XOR, with the key being 0x42.

- Waiting for `interactive`

    - Receive Command
    ![](./re-init-receive.png)

    - Code 3,8,9: `Execute command line`
    ![](./re-init-389-cmd.png)

    - Code 4: `Write file`
    ![](./re-init-4-writefile.png)

    - Code 5: `Download file`
    ![](./re-init-5-downloadfile.png)

    - Code 11: `Ping check`
    ![](./re-init-11-ping.png)

- Capture C&C Command
![](./c2-server-commands.png)

Because the C2 server was shutdown, it was not possible to determine what shell commands it would deliver for execution.

## Threat Assessment

This malware disguises itself as a legitimate OpenVPN application to trick users into opening it. Upon execution, it launches a backdoor process that waits for commands from the C2 server.
